<?php

declare(strict_types=1);

namespace Algoritma\CodingStandardsTest\Installer\Writer;

use Algoritma\CodingStandards\Installer\Writer\PhpstanAlgoritmaConfigWriter;
use Algoritma\CodingStandardsTest\Framework\TestCase;

class PhpstanAlgoritmaConfigWriterTest extends TestCase
{
    private string $filename;

    protected function setUp(): void
    {
        parent::setUp();

        $this->filename = tempnam(sys_get_temp_dir(), 'phpstan-algoritma');
    }

    protected function tearDown(): void
    {
        parent::tearDown();

        if (file_exists($this->filename)) {
            unlink($this->filename);
        }
    }

    public function testWriteConfigFile(): void
    {
        $writer = new PhpstanAlgoritmaConfigWriter();

        $writer->writeConfigFile($this->filename);

        $content = file_get_contents($this->filename);

        $expected
            = <<<'EOD'
                <?php
                /**
                 * Autogenerated Configuration. DO NOT EDIT.
                 */
                $autoloadPathProvider = new Algoritma\CodingStandards\AutoloadPathProvider();

                $additionalRules = [];
                $rulesProvider = new Algoritma\CodingStandards\Rules\CompositeRulesProvider([
                    new Algoritma\CodingStandards\Rules\PhpstanRulesProvider(),
                    new Algoritma\CodingStandards\Rules\ArrayRulesProvider($additionalRules),
                ]);
                
                /**
                 * Paths need to be absolute only on PHP Configuration.
                 */
                $paths = array_map(
                    static function(string $path) {
                        return \Symfony\Component\Filesystem\Path::makeAbsolute($path, __DIR__);
                    }, $autoloadPathProvider->getPaths());

                $paths = array_values(array_unique($paths));

                return [
                    'parameters' => [
                        'paths' => $paths,
                        'treatPhpDocTypesAsCertain' => false,
                        'inferPrivatePropertyTypeFromConstructor' => true,
                        'type_perfect' => [
                            'no_mixed_property' => true,
                            'no_mixed_caller' => true,
                            'null_over_false' => true,
                            'narrow_param' => true,
                            'narrow_return' => true,
                        ],
                        'errorFormat' => 'ticketswap',
                        'editorUrl' => 'phpstorm://open?file=%%file%%&line=%%line%%',
                    ],
                    'rules' => $rulesProvider->getRules()
                ];

                EOD;

        self::assertSame($expected, $content);
    }

    public function testWriteConfigFileWithNoDev(): void
    {
        $writer = new PhpstanAlgoritmaConfigWriter();

        $writer->writeConfigFile($this->filename, true);

        $content = file_get_contents($this->filename);

        $expected
            = <<<'EOD'
                <?php
                /**
                 * Autogenerated Configuration. DO NOT EDIT.
                 */
                $autoloadPathProvider = new Algoritma\CodingStandards\AutoloadPathProvider(null, null, false);
                
                $additionalRules = [];
                $rulesProvider = new Algoritma\CodingStandards\Rules\CompositeRulesProvider([
                    new Algoritma\CodingStandards\Rules\PhpstanRulesProvider(),
                    new Algoritma\CodingStandards\Rules\ArrayRulesProvider($additionalRules),
                ]);
                
                /**
                 * Paths need to be absolute only on PHP Configuration.
                 */
                $paths = array_map(
                    static function(string $path) {
                        return \Symfony\Component\Filesystem\Path::makeAbsolute($path, __DIR__);
                    }, $autoloadPathProvider->getPaths());

                $paths = array_values(array_unique($paths));

                return [
                    'parameters' => [
                        'paths' => $paths,
                        'treatPhpDocTypesAsCertain' => false,
                        'inferPrivatePropertyTypeFromConstructor' => true,
                        'type_perfect' => [
                            'no_mixed_property' => true,
                            'no_mixed_caller' => true,
                            'null_over_false' => true,
                            'narrow_param' => true,
                            'narrow_return' => true,
                        ],
                        'errorFormat' => 'ticketswap',
                        'editorUrl' => 'phpstorm://open?file=%%file%%&line=%%line%%',
                    ],
                    'rules' => $rulesProvider->getRules()
                ];

                EOD;

        self::assertSame($expected, $content);
    }
}
